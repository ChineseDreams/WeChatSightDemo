<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" name="viewport" />
    <meta content="telephone=no" name="format-detection" />
    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/com.js"></script>
    <script src="../../js/touchevent.js"></script>
    <link href="../../css/commom.css" rel="stylesheet" />
    <title>家庭作业</title>
    <style>
        body {
            -webkit-user-select: none;
        }
    </style>
    <script>

        var user_type = request("user_type");
        var uid = request("uid");
        var uid_child = request("uid_child");
        var school_id = request("school_id");
        var class_id = request("class_id");
        var date = request("date");

        if (strIsNullOrEmpty(school_id)) {
            school_id = "0";
        }

        var index = 1;
        var size = 10;
        var count = 0;
        var firstLoad = true;
        var can_scorll = true;   //是否能滑动加载
        $(function () {
            $(".can_remove").hide();
            if (type == "1" || type == "0") {
                $(".can_remove").remove();
                document.addEventListener('WebViewJavascriptBridgeReady', function (event) {
                    bridge = event.bridge;
                    bridge.init(function (message, responseCallback) { });
                    bridge.registerHandler("onClickBack", function (data, responseCallback) {
                        if (clear) {  //在清空界面
                            clear = false;
                            $(".overlay").hide();
                        }
                        else {
                            if (!can_scorll) {   //在批量删除界面，则返回到列表，否则返回上一页
                                dialogbox("确定退出批量删除？", function () {
                                    //这里应该恢复滑动加载，恢复右键菜单和title
                                    cancel();
                                    SetMenu();
                                });
                            }
                            else {
                                var array = {
                                    title: null,
                                    url: null,
                                    urlType: 0,
                                    close: true,
                                    children: []
                                }
                                responseCallback(array);
                            }
                        }
                    });
                }, false);
            }
            else {
                $(".can_remove").show();
            }
            if (request("has_class") != "1") {
                $("body").html("<img src='../../images/jiatingzuoye.png' class='classimg' /><div class='nodata nohomework'> 您还没有班级！</div>");
                return;
            }
            $("#BZ").hide();
            $("#SX").hide();
            if (type != "0" && type != "1") {
                $("#SX").show();
                if (user_type == "0") {
                    $("#BZ").show();
                }
            }

            GetList();
            setTimeout(function () { UpdateInfo(5536242) }, 5000)
        });


        $(window).scroll(function () {
            if (can_scorll) {

                var scrollTop = $(this).scrollTop();
                var scrollHeight = $(document).height();
                var windowHeight = $(this).height();
                if (scrollTop + windowHeight == scrollHeight) {
                    setTimeout(function () {
                        GetList();
                    }, 400);
                }
            }
        })

        function GetList() {
            if (firstLoad || (index - 1) * size < count) {
                $.ajax({
                    type: "get",
                    async: true,
                    url: domain + "api/HSCForImageURL/GetMessageList",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        class_id: class_id,
                        school_id: school_id,
                        mes_type_id: getMesTypeId("作业"),
                        date: date,
                        status: 0,
                        pageindex: index,
                        pagesize: size
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        var listStr = "";
                        //listStr += "<div class='bgblock'>";
                        if (data.rows.length > 0) {

                            for (var i = 0; i < data.rows.length; i++) {

                                var plan = new Date(convertDateTimeToString(parseISO8601(data.rows[i].get_date)).replace(/-/g, '/'));
                                var now = new Date();

                                if (user_type == "0") {
                                    listStr += "<div class='bb1  wb relative bgwhite litems' id=\"" + data.rows[i].mes_send_id + "\">";

                                }
                                else {
                                    listStr += "<div class='bb1  wb relative bgwhite litems' id=\"" + data.rows[i].id + "\">";
                                }

                                //if (!((uid == data.rows[i].uid_send && user_type == "0" && plan > now) || (data.rows[i].mes_status != "1" && user_type == "0")) && !(uid == data.rows[i].uid_get && user_type == "1")) {
                                if (false) {
                                    listStr += "<div class='widper100 relative  patb bgwhite'>";

                                    if (user_type == "0") {
                                        listStr += "<div  class='cli' onclick=\"GoDetail(" + data.rows[i].mes_send_id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "',null,this," + data.rows[i].uid_send + ")\">"; //

                                    }
                                    else {
                                        listStr += "<div class='cli'   onclick=\"GoDetail(" + data.rows[i].id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "'," + data.rows[i].uid_child + ",this," + data.rows[i].uid_send + ")\">";//

                                    }
                                } else {
                                    //删除
                                    if (type == "0") {
                                        //if (user_type == "0") {
                                        //    listStr += "<div class='andelete wb hide'><div class='patblr' onclick=\"event.stopPropagation();Del(" + data.rows[i].mes_send_id + ",'send')\">删除</div><div class='ancancel patblr' onclick='cancel(this)'>取消 </div></div>";
                                        //}
                                        //else if (user_type == "1" || user_type == "4") {
                                        listStr += "<div class='andelete wb hide'><div class='patblr' onclick=\"event.stopPropagation();Del(" + data.rows[i].id + ")\">删除</div><div class='ancancel patblr' onclick='cancel(this)'>取消 </div></div>";
                                        //}
                                    }
                                    listStr += "<div class='nitem widper100 relative bgwhite patbb'>";
                                    if (user_type == "0") {
                                        listStr += "<div  class='cli' clickEvent=\"GoDetail(" + data.rows[i].mes_send_id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "',null,this," + data.rows[i].uid_send + ")\">"; //
                                    }
                                    else {
                                        listStr += "<div class='cli'   clickEvent=\"GoDetail(" + data.rows[i].id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "'," + data.rows[i].uid_child + ",this," + data.rows[i].uid_send + ")\">";//
                                    }
                                }

                                if (user_type == "0") {
                                    if (uid == data.rows[i].uid_send) {
                                        listStr += "<div class='widper100 wb'>";
                                        listStr += "<div  class='mlper3' >";
                                        listStr += "<img class='noticeitem mt10' src='../../images/unread_hknotitle.png'>";

                                    } else {
                                        listStr += "<div class='widper100 wb'>";
                                        listStr += "<div class='mlper3'>";
                                        listStr += "<img class='noticeitem mt10' src='../../images/unread_hkhastitle.png'>";
                                    }

                                }
                                else {
                                    if (data.rows[i].status == "0") {
                                        listStr += "<div class='widper100 wb'>";
                                        listStr += "<div class='mlper3'>";
                                        listStr += "<img class='noticeitem mt10' src='../../images/unread_hkhastitle.png'>";
                                    } else {
                                        listStr += "<div class='widper100 wb'>";
                                        listStr += "<div class='mlper3' >";
                                        listStr += "<img class='noticeitem mt10' src='../../images/read_hkhastitle.png'>";
                                    }
                                }
                                listStr += "</div>"
                                listStr += "<div class='nowrap flex2 mt10'>"
                                listStr += "<div class='wb widper100 indentb'>"
                                if (user_type == "0") {
                                    if (!strIsNullOrEmpty(data.rows[i].title)) {
                                        listStr += "<div class=' widper60 nowrap mes_title'>" + data.rows[i].title + "</div>";
                                    } else {
                                        listStr += "<div class='  widper60 nowrap'>全部作业 </div>";
                                    }
                                } else {
                                    if (data.rows[i].status == "0") {
                                        listStr += "<div class='  widper60 nowrap mes_title'>" + (!strIsNullOrEmpty(data.rows[i].title) ? data.rows[i].title : '全部作业') + "</div>";
                                    } else {
                                        listStr += "<div class='  widper60 nowrap g-font mes_title'>" + (!strIsNullOrEmpty(data.rows[i].title) ? data.rows[i].title : '全部作业') + "</div>";
                                    }
                                }

                                var date = new Date();
                                var today = date.getFullYear() + '-' + padLeft((parseInt(date.getMonth()) + 1), 2) + '-' + padLeft(date.getDate(), 2);
                                if (convertDateToString(parseISO8601(data.rows[i].get_date)) == today) {
                                    listStr += "<div class='widper32 g-font tright p15 mes_get_date'>" + convertTimeToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                }
                                else if (convertYearToString(parseISO8601(data.rows[i].get_date)) == date.getFullYear().toString()) {
                                    listStr += "<div class='widper32 g-font tright p15 mes_get_date'>" + convertMothDayToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                }
                                else {
                                    listStr += "<div class='widper32 g-font tright mes_get_date'>" + convertDateToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                }
                                //listStr += "<div class='widper20 g-font tright'>" + convertTimeToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                listStr += "</div>"
                                if (strIsNullOrEmpty(class_id) && !strIsNullOrEmpty(data.rows[i].grade_class_name)) {
                                    listStr += "<div class='g-font grade_class_name  indentb ' style='width: 88%; overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + data.rows[i].grade_class_name + "</div>";
                                }
                                listStr += "<div class='wb '>"
                                if (!strIsNullOrEmpty(data.rows[i].context) && data.rows[i].context.length > 32) {
                                    if (user_type == "0" && uid == data.rows[i].uid_send) {
                                        listStr += "<div class='  g-font mt-2 widper60 nowrap mlhalf mes_context'>" + data.rows[i].context.substr(0, 32) + "…" + "</div>";
                                    }
                                    else {
                                        if (data.rows[i].status == "0") {
                                            listStr += "<div class='  g-font  mt2 widper60 nowrap indentb mes_context'>" + data.rows[i].context.substr(0, 32) + "…" + "</div>";
                                            if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                                if (data.rows[i].mes_status == "0") {
                                                    listStr += "<div class='widper30 y-font tright mes_status  '>未审核</div>";
                                                }
                                                else if (data.rows[i].mes_status == "2") {
                                                    listStr += "<div class='widper30 y-font tright mes_status '>未通过</div>";
                                                }
                                            }

                                        } else {
                                            listStr += "<div class=' g-font mt-2 widper60 nowrap mlhalf mes_context'>" + data.rows[i].context.substr(0, 32) + "…" + "</div>";
                                            if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                                if (data.rows[i].mes_status == "0") {
                                                    listStr += "<div class='widper30 y-font tright mes_status '>未审核</div>";
                                                }
                                                else if (data.rows[i].mes_status == "2") {
                                                    listStr += "<div class='widper30 y-font tright mes_status '>未通过</div>";
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    if (user_type == "0" && uid == data.rows[i].uid_send) {
                                        listStr += "<div class=' g-font widper60 nowrap indentb mes_context'>" + (strIsNullOrEmpty(data.rows[i].context) ? "" : data.rows[i].context) + "</div>";
                                        if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                            if (data.rows[i].mes_status == "0") {
                                                listStr += "<div class='widper30 y-font tright mes_status '>未审核</div>";
                                            }
                                            else if (data.rows[i].mes_status == "2") {
                                                listStr += "<div class='widper30 y-font tright mes_status '>未通过</div>";
                                            }
                                        }
                                    }
                                    else {
                                        if (data.rows[i].status == "0") {
                                            listStr += "<div class='  g-font widper60 nowrap mlhalf mt2 mes_context'>" + (strIsNullOrEmpty(data.rows[i].context) ? "" : data.rows[i].context) + "</div>";
                                            if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                                if (data.rows[i].mes_status == "0") {
                                                    listStr += "<div class='widper30 y-font tright mes_status '>未审核</div>";
                                                }
                                                else if (data.rows[i].mes_status == "2") {
                                                    listStr += "<div class=widper30 y-font tright mes_status '>未通过</div>";
                                                }
                                            }
                                        } else {
                                            listStr += "<div class='  g-font widper60 nowrap indentb mes_context'>" + (strIsNullOrEmpty(data.rows[i].context) ? "" : data.rows[i].context) + "</div>";
                                            if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                                if (data.rows[i].mes_status == "0") {
                                                    listStr += "<div class='widper30 y-font tright mes_status p15'>未审核</div>";
                                                }
                                                else if (data.rows[i].mes_status == "2") {
                                                    listStr += "<div class='widper30 y-font tright mes_status p15'>未通过</div>";
                                                }
                                            }
                                        }
                                    }
                                }
                                listStr += "</div>"
                                listStr += "<div class='mes_imgs wb mlper3'>";
                                if (!strIsNullOrEmpty(data.rows[i].image)) {
                                    //图片
                                    if (!strIsNullOrEmpty(data.rows[i].image)) {
                                        if (data.rows[i].image.indexOf(',') >= 0) {
                                            var imgs = data.rows[i].image.split(',');
                                            for (var k = 0; k < imgs.length; k++) {
                                                if (!strIsNullOrEmpty(imgs[k])) {
                                                    listStr += "<div class='hkimg'>"
                                                    listStr += "<img  src='" + imgs[k] + "' />";
                                                    listStr += "</div>"
                                                }
                                            }
                                        }
                                        else {
                                            listStr += "<img  class='listimg'  src='" + data.rows[i].image + "'/>";
                                        }
                                    }
                                }
                                listStr += "</div>";
                                listStr += "</div>"
                                listStr += "</div>"
                                //if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                //    if (data.rows[i].mes_status == "0") {
                                //        listStr += "<div class='mlper10 y-font'>未审核</div>";
                                //    }
                                //    else if (data.rows[i].mes_status == "2") {
                                //        listStr += "<div class='mlper10 g-font'>未通过</div>";
                                //    }
                                //}

                                listStr += "</div>";
                                listStr += "</div>";
                                if (type == "1" || strIsNullOrEmpty(type)) {
                                    //if ((uid == data.rows[i].uid_send && user_type == "0" && plan > now) || (data.rows[i].mes_status != "1" && user_type == "0")) {
                                    //    //删除
                                    //    listStr += "<div class='cli '><button  class='hkdelete' type='button' onclick=\"event.stopPropagation();Del(" + data.rows[i].mes_send_id + ",'send')\">删除</button></div>";
                                    //}
                                    //if (uid == data.rows[i].uid_get && user_type == "1") {
                                    //删除
                                    listStr += "<div  class='cli'><button   class='hkdelete'  type='button' onclick=\"event.stopPropagation();Del(" + data.rows[i].id + ")\">删除</button></div>";
                                    //}
                                }
                                listStr += "</div>";
                                //listStr += "</div>";
                            }
                            //listStr += '</div>';

                            $("#list").append(listStr);
                            count = data.total;
                            index++;
                            firstLoad = false;
                            touchev()
                        }
                        else {
                            $("#list").html("<div class='nodata nohomework'>还没有家庭作业哦！</div>");
                        }
                        $(".loading").remove();
                    }
                });
            }
        }

        function GoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send) {
            //console.log("zheli");
            //判断用户是否有查看详情的条件
            if (user_type == "1") {
                if (type == "1") {
                    bridge.callHandler("isHidden", {}, function (data) {
                        var isHidden = data.isHidden;
                        if (isHidden) {
                            Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj, 1);
                        }
                        else {
                            GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send);
                        }
                    });
                }
                else {
                    GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send);
                }


            }
            else {
                if (mes_status == "0") {

                    var array = {
                        title: '作业详情',
                        url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&date=" + date + "&message_type_name=" + message_type_name + "&message_type_id=3" + "&version=" + request("version"),
                        urlType: 1,
                        close: false,
                        children: [
                        {
                            title: '修改',
                            url: 'Update()',
                            urlType: 2,
                            childTitle: ''
                        }]
                    };
                    appRedirect(array);
                }
                else {
                    if (uid == uid_send) {
                        var array = {
                            title: '作业详情',
                            url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&date=" + date + "&message_type_name=" + message_type_name + "&message_type_id=3" + "&version=" + request("version"),
                            urlType: 1,
                            close: false,
                            children: [
                            {
                                title: '查看统计',
                                url: 'ShowReport()',
                                urlType: 2,
                                childTitle: ''
                            }]
                        };
                        appRedirect(array);
                    }
                    else {
                        var array = {
                            title: '作业详情',
                            url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&date=" + date + "&message_type_name=" + message_type_name + "&message_type_id=3" + "&version=" + request("version"),
                            urlType: 1,
                            close: false,
                            children: []
                        };
                        appRedirect(array);
                    }
                }
            }

        }

        function GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send) {
            $.ajax({
                type: "get",
                async: true,
                url: domain + "api/HomeSchoolCommunication/MessageShowForUser",
                data: {
                    uid: uid,
                    class_id: class_id,
                    is_now: is_now,
                    id: id,
                    message_type_id: 3
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                }, success: function (data) {
                    if (data.res == "0") {
                        var res_user_pay_type = data.res_user_pay_type;
                        if (res_user_pay_type == "2") {
                            var res_pay_score = data.res_pay_score;
                            var is_remind = 1;
                            if (type == "1" || type == "0") {
                                bridge.callHandler("getScoreReminder", { module: 3 }, function (data) {
                                    if (type == "0") {
                                        data = JSON.parse(data);
                                    }
                                    is_remind = data.is_remind;
                                    if (is_remind == 0) {
                                        Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                                    }
                                    else {
                                        Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                                    }
                                });
                            } else {
                                Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                            }
                            //else if (type == "0" && 'surfaceView' in window) {
                            //    is_remind = surfaceView.getScoreReminder(3);
                            //    if (is_remind == 0) {
                            //        Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                            //    }
                            //    else {
                            //        Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                            //    }
                            //}

                        }
                        else {
                            Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                        }
                    }
                    else if (data.res == "2") {
                        choicetwo("积分不足，无法查阅！", "取消", function () { $('.overlay').hide(); }, "查看服务", function () {
                            var array = {
                                title: '班级服务',
                                url: '/customer/classservice.html?uid=' + uid + "&classid=" + class_id,
                                urlType: 1,
                                close: false,
                                children: []
                            };
                            appRedirect(array);
                        });
                    }
                    else if (data.res == "3") {
                        choicetwo("您没有购买班级包月服务，无法查阅！", "取消", function () { $('.overlay').hide(); }, "查看服务", function () {
                            var array = {
                                title: '班级服务',
                                url: '/customer/classservice.html?uid=' + uid + "&classid=" + class_id,
                                urlType: 1,
                                close: false,
                                children: []
                            };
                            appRedirect(array);
                        });
                    }
                    else if (data.res == "4") {
                        error("参数不足，不能查看");
                    }
                    else if (data.res == "5") {
                        error("该条" + getMesTypeName(3, 1) + "已被您删除，您无法查看详情");
                    }
                }
            });
        }

        function Del(id) {
            clear = true;
            choicetwo("确认删除？", "取消", function () { clear = false;touchev() }, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                //$.ajax({
                //    type: "get",
                //    async: false,
                //    url: domain + "api/HomeSchoolCommunication/MessageDelete",
                //    data: {
                //        id: id,
                //        someWhere: someWhere
                //    },
                //    error: function (XMLHttpRequest, textStatus, errorThrown) {
                //        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                //    }, success: function (data) {
                //        if (data.res > 0) {
                //            error("删除成功！");
                //            $("#" + id).remove();
                //        }
                //        else {
                //            error("删除失败！");
                //        }
                //        return false;
                //    }
                //});
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesDelLot",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        ids: id
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $(".loading").remove();
                        clear = false;
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            location.reload();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });
        }

        function SX() {
            var array = {
                title: '筛选作业',
                url: '/HomeSchoolCommunication/homework/classSelect.html?uid=' + uid + "&uid_child=" + uid_child + "&school_id=" + school_id + "&user_type=" + user_type + "&class_id=" + class_id + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: [
                    {
                        title: '完成',
                        url: 'Sel()',
                        urlType: 2,
                        childTitle: ''
                    }]
            };
            appRedirect(array);
        }

        function BZ() {
            var array = {
                title: '布置作业',
                url: '/HomeSchoolCommunication/messageAdd.html?mes_type_id=3&uid=' + uid + "&uid_child=" + uid_child + "&school_id=" + school_id + "&user_type=" + user_type + "&class_id=" + class_id + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: [
                    {
                        title: '发布',
                        url: 'Filish()',
                        urlType: 2,
                        childTitle: ''
                    }
                ]
            };
            appRedirect(array);
        }

        function Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj) {
            if (res_pay_score > 0) {

                dialogbox("<div>查看详情需要扣除您" + res_pay_score + "积分，确认查看？</div><div class='mt10'><label class=' relative label mt10' onclick='ischeck(this,true)'><input class='ckbox ckboxout' type=\"checkbox\" id=\"remind\" /><span class='mlonerem  g-font'>不再提示</span></label></div>", function () {

                    if (isChecked($("#remind"))) {
                        if (type == "1" || type == "0") {
                            bridge.callHandler("setScoreReminder", { module: 3, is_remind: 0 });
                        }
                        //else if (type == "0" && 'surfaceView' in window) {
                        //    surfaceView.setScoreReminder(JSON.stringify({ module: 3, is_remind: 0 }));
                        //}
                    }

                    Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                });
            }
            else {
                Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
            }
        }

        function Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj, nocut) {
            $(obj).addClass("g-font");
            $(obj).find(".noticeitem").attr("src", "../../images/read_hkhastitle.png");

            var array = {
                title: '作业详情',
                url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&school_id=" + school_id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child1 + "&class_id=" + class_id + "&message_type_name=" + message_type_name + (!strIsNullOrEmpty(nocut) ? "&nocut=" + nocut : "") + "&message_type_id=3" + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: []
            };
            //console.log("跳转了 ");
            appRedirect(array);
        }

        function SetMenu() {
            $(".delLot").removeClass("ckboxon");
            $(".delLot").addClass("ckboxout");
            $(".chkall").removeClass("ckboxon");
            $(".chkall").addClass("ckboxout");
            can_scorll = true;
            addListener();
            //设置右键
            var children2 = [];
            children2.push({
                title: "筛选作业",
                url: 'SX()',
                urlType: 2,
                childTitle: ''
            });
            if (hasRole(uid, school_id, class_id, user_type, "3") && user_type == 0) {
                children2.push({
                    title: "布置作业",
                    url: 'BZ()',
                    urlType: 2,
                    childTitle: ''
                });
            }
            children2.push({
                title: "清空",
                url: 'delAll()',
                urlType: 2,
                childTitle: ''
            });
            children2.push({
                title: "批量删除",
                url: 'deleteItem()',
                urlType: 2,
                childTitle: ''
            });
            //if (roleCount > 1) {
            //    children2.push({
            //        title: "切换班级",
            //        url: 'changeIdentity()',
            //        urlType: 2,
            //        childTitle: ''
            //    });
            //}

            var paramArray = {
                title: "家庭作业",
                children: children2
            }
            resetTitle(paramArray);
        }

        //.ckall 点击事件
        function ckallclick() {
            var isc = $(".chkall").prop('checked');
            //$(".delLot").attr("checked", isc);
            if (isc) {
                $(".delLot").each(function () {
                    $(this).prop('checked', true);
                    $(this).addClass('ckboxon');
                    $(this).removeClass('ckboxout');
                })
            } else {
                $(".delLot").each(function () {
                    $('.chkall').prop('checked', false)
                    $(this).addClass('ckboxout');
                    $(this).removeClass('ckboxon');
                })
            }
            //ischeckSpecile($(".delLot"), false);
            if (isc) {
                $(".span_chkall").text("取消全选");
            }
            else {
                $(".span_chkall").text("全选");
            }
            var jalen;
            jalen = $('.delLot.ckboxon').length;
            UpdateMenu(jalen);
        }
        // .delLot 点击事件
        function delLotclick(a) {
            var isc = $(a).find("input").prop("checked");
            if (!isc) {
                //$(".chkall").attr("checked", false);
                $('.chkall').prop('checked', false)
                $('.chkall').addClass('ckboxout');
                $('.chkall').removeClass('ckboxon');
                $(".span_chkall").text("全选");
            }
            else {
                if ($(".delLot.ckboxon").length == $(".delLot").length) {
                    $('.chkall').addClass('ckboxon');
                    $('.chkall').prop('checked', true)
                    $('.chkall').removeClass('ckboxout');
                    $(".span_chkall").text("取消全选");
                }
                else {
                    // $(".chkall").attr("checked", false);
                    $('.chkall').prop('checked', false)
                    $('.chkall').addClass('ckboxout');
                    $('.chkall').removeClass('ckboxon');
                    $(".span_chkall").text("全选");
                }
            }
            //ischeckSpecile($(".chkall"), false);
            UpdateMenu($(".delLot.ckboxon").length);
        }
        //取消批量删除
        function UpdateMenu(selCount) {
            var paramArray =
            {
                title: "已选择" + selCount,
                children: [{
                    title: "删除",
                    url: 'delLot()',
                    urlType: 2,
                    childTitle: ''
                }]
            };
            resetTitle(paramArray);
        }
        //添加多选框，批量删除
        function deleteItem() {
            if (count == 0) {
                error("没有可删除的消息");
                return;
            }
            $('.nitem').each(function () {
                $(this).removeClass('moveleft')
                $(this).addClass('moveright')
            })
            removeListener();
            can_scorll = false;
            UpdateMenu("0");
            var checkAll = '<div class="bgwhite bb1 del-all classitem">' +
                ' <label class="label relative wid100  mlhalf" onclick="ischeck(this, true),ckallclick();">' +
                     '  <input type="checkbox" class="ckbox chk_class ckboxout chkall" checked="">' +
                  ' <span class="labelspan mlonerem span_chkall">全选</span>' +
                  ' </label>' +
                '</div>';
            if ($('.del-all').length == 0) {
                $('#list').prepend(checkAll);
            } else {
                $('.del-all').show();
                $('.del-item').removeClass('del-hide').show();
            }
            if ($('.del-item').length !== 0) return;

            $('.litems').each(function () {
                var id = $(this).attr("id");
                var checkObj = ' <label class="mt26 label relative wid100  mlhalf block del-item" onclick="ischeck(this, true),delLotclick(this);">' +
                        ' <input type="checkbox" class="ckbox chk_class ckboxout ckchild delLot" value="' + id + '">' +
                        '<span class="labelspan"></span>' +
                        ' </label>';
                $(this).find('.noticeitem ').parent().parent().parent().parent().parent().prepend(checkObj);
                $(this).css('overflow', 'hidden');
            })
            //$(".chkall").click(function () {
            //    var isc = isChecked($(".chkall"));
            //    $(".delLot").attr("checked", isc);
            //    ischeckSpecile($(".delLot"), false);
            //    UpdateMenu($(".delLot:checked").length);
            //    if (isc) {
            //        $(".span_chkall").text("取消全选");
            //    }
            //    else {
            //        $(".span_chkall").text("全选");
            //    }
            //});
            //$(".delLot").click(function () {
            //    var isc = isChecked($(this));
            //    if (!isc) {
            //        $(".chkall").attr("checked", false);
            //        $(".span_chkall").text("全选");
            //    }
            //    else {
            //        if ($(".delLot:checked").length == $(".delLot").length) {
            //            $(".chkall").attr("checked", true);
            //            $(".span_chkall").text("取消全选");
            //        }
            //        else {
            //            $(".chkall").attr("checked", false);
            //            $(".span_chkall").text("全选");
            //        }
            //    }
            //    ischeckSpecile($(".chkall"), false);
            //    UpdateMenu($(".delLot:checked").length);
            //});
        }

        //取消批量删除
        function cancel() {
            $('.del-all').hide();
            $('.del-item').addClass('del-hide').one('webkitAnimationEnd', function () { $(this).hide() });
        }

        function delLot() {
            var ids = "";
            $(".delLot").each(function () {
                //if (isChecked($(this))) {
                //    ids = ids + $(this).val() + ",";
                //}
                if ($(this).hasClass('ckboxon')) {
                    ids = ids + $(this).val() + ",";
                }
            });
            if (strIsNullOrEmpty(ids)) {
                error("请选择要删除的作业");
                return;
            }
            clear = true;
            choicetwo("确认删除已勾选的作业？", "取消", function () { clear = false; }, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesDelLot",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        ids: ids
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        clear = false;
                        $(".loading").remove();
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            SetMenu();
                            //location.reload();
                            index = 1;
                            size = 10;
                            count = 0;
                            firstLoad = true;
                            can_scorll = true;
                            firstLoad = true;
                            $("body").append('<div class="loading">加载中...</div>');
                            $("#list").html("");
                            GetList();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });

        }

        function onClickBack() {
            if (clear) {  //在清空界面
                clear = false;
                $(".overlay").hide();
            }
            else {
                if (!can_scorll) {   //在批量删除界面，则返回到列表，否则返回上一页
                    dialogbox("确定退出批量删除？", function () {
                        //这里应该恢复滑动加载，恢复右键菜单和title
                        cancel();
                        SetMenu();
                    });
                }
                else {
                    var array = {
                        title: '',
                        url: '',
                        urlType: 1,
                        close: true,
                        children: []
                    };
                    appRedirect(array);
                }
            }
        }

        var clear = false;
        function delAll() {
            if (count == 0) {
                error("没有可清空的消息");
                return;
            }
            clear = true;
            choicetwo("确认清空家庭作业？", "取消", function () { clear = false; }, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesClear",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        school_id: school_id,
                        class_id: class_id,
                        mes_type_id: 3
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $(".loading").remove();
                        clear = false;
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            location.reload();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });
        }

        function UpdateInfo(id) {
            if (!strIsNullOrEmpty(id) && id > 0) {

                $.ajax({
                    type: "get",
                    async: true,
                    url: domain + "api/HSCForImageURL/GetSendInfo",
                    data: {
                        id: id,
                        is_now: null,
                        user_type: user_type,
                        uid: uid,
                        class_id: class_id,
                        uid_child: null,
                        message_type_name: ""
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        //error(XMLHttpRequest.responseText)
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {

                        if (data != null && data.rows != null && data.rows.length > 0) {
                            for (var i = 0; i < data.rows.length; i++) {
                                var obj = $("#" + id.toString());
                                $(obj).find(".mes_title").html(data.rows[i].title);

                                var str_date = '';
                                var date = new Date();
                                var today = date.getFullYear() + '-' + padLeft((parseInt(date.getMonth()) + 1), 2) + '-' + padLeft(date.getDate(), 2);
                                if (convertDateToString(parseISO8601(data.rows[i].get_date)) == today) {
                                    str_date = convertTimeToString(parseISO8601(data.rows[i].get_date));
                                }
                                else if (convertYearToString(parseISO8601(data.rows[i].get_date)) == date.getFullYear().toString()) {
                                    str_date = convertMothDayToString(parseISO8601(data.rows[i].get_date));
                                }
                                else {
                                    str_date = convertDateToString(parseISO8601(data.rows[i].get_date));
                                }
                                $(obj).find(".mes_get_date").html(str_date);
                                $(obj).find(".mes_status").html(data.rows[i].status == "0" ? "未审核" : data.rows[i].status == "1" ? "" : "未通过");
                                $(obj).find(".mes_context").html(subStr(data.rows[i].context, 32));
                                $(obj).find(".grade_class_name").html(data.rows[i].class_names);

                                var listStr = "";
                                if (!strIsNullOrEmpty(data.rows[i].mes_pic)) {
                                    //图片
                                    if (!strIsNullOrEmpty(data.rows[i].mes_pic)) {
                                        if (data.rows[i].mes_pic.indexOf(',') >= 0) {
                                            var imgs = data.rows[i].mes_pic.split(',');
                                            for (var k = 0; k < imgs.length; k++) {
                                                if (!strIsNullOrEmpty(imgs[k])) {
                                                    listStr += "<div class='hkimg'>"
                                                    listStr += "<img  src='" + imgs[k] + "' />";
                                                    listStr += "</div>"
                                                }
                                            }
                                        }
                                        else {
                                            listStr += "<img  class='listimg'  src='" + data.rows[i].mes_pic + "'/>";
                                        }
                                    }
                                }
                                $(obj).find(".mes_imgs").html(listStr);
                                if (strIsNullOrEmpty(listStr)) {
                                    //$(obj).find(".mes_imgs").remove();
                                    $(obj).css("height","97px");
                                }
                            }
                        }

                    }
                });
            }
        }
    </script>
</head>
<body style="min-height:24rem;">
    <input type="button" class="can_remove hide" value="删除" onclick="delLot()" />
    <input type="button" class="can_remove hide" value=" 清空" onclick="delAll()" />
    <input type="button" class="can_remove hide " value=" 返回" onclick="onClickBack()" />
    <div>
        <div id="pageContext" class="">
            <img src="../../images/jiatingzuoye.png" class="classimg" />
            <div id="button">
                <!--class="heithreerem"-->
                <button type="button" id="SX" onclick="SX()" class="can_remove hide hmbutton sx">筛选作业</button>
                <button type="button" id="BZ" onclick="BZ()" class="can_remove hide hmbutton bz">布置作业</button>
                <button type="button" onclick="deleteItem()" class="can_remove hide hmbutton bz">批量删除</button>

            </div>
            <!--<div style="height:1rem"></div>-->
            <div id="list">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <div id="class_list"></div>
    </div>
</body>
</html>
