<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" name="viewport" />
    <meta content="telephone=no" name="format-detection" />
    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/com.js"></script>
    <script src="../../js/touchevent.js"></script>
    <link href="../../css/commom.css" rel="stylesheet" />
    <title>学校通知</title>
    <script>

        var user_type = request("user_type");
        var uid = request("uid");
        var uid_child = request("uid_child");
        var school_id = request("school_id");
        var class_id = request("class_id");
        var txt = request("txt");
        var loadUnread = 1;



        var index = 1;
        var size = 10;
        var count = 0;
        var firstLoad = true;
        var can_scorll = true;   //是否能滑动加载
        $(function () {
            $(".can_remove").hide();
            if (type == "1" || type == "0") {
                $(".can_remove").remove();
                document.addEventListener('WebViewJavascriptBridgeReady', function (event) {
                    bridge = event.bridge;
                    bridge.init(function (message, responseCallback) { });

                    if (!strIsNullOrEmpty(uid) && strIsNullOrEmpty(user_type) && strIsNullOrEmpty(class_id)) {
                        bridge.callHandler("getUserInfo", {}, function (data) {
                            if (!strIsNullOrEmpty(data)) {
                                if (type == "0") {
                                    data = JSON.parse(data);
                                }
                                UserInfo(data.school_id, data.class_id, data.user_type);
                            }
                            else {
                                UserInfo(school_id, class_id, user_type);
                            }
                            SetMenu();

                            if (loadUnread == 1) {
                                GetList();
                            }
                        })
                    }
                    else {
                        UserInfo(school_id, class_id, user_type);
                        SetMenu();

                        if (loadUnread == 1) {
                            GetList();
                        }
                    }

                    bridge.registerHandler("onClickBack", function (data, responseCallback) {
                        if (clear) {  //在清空界面
                            clear = false;
                            $(".overlay").hide();
                        }
                        else {
                            if (!can_scorll) {   //在批量删除界面，则返回到列表，否则返回上一页
                                dialogbox("确定退出批量删除？", function () {
                                    //这里应该恢复滑动加载，恢复右键菜单和title
                                    cancel();
                                    SetMenu();
                                });
                            }
                            else {
                                var array = {
                                    title: null,
                                    url: null,
                                    urlType: 0,
                                    close: true,
                                    children: []
                                }
                                responseCallback(array);
                            }
                        }
                    });
                }, false);
            }
            else {
                $(".can_remove").show();
                UserInfo(school_id, class_id, user_type);
            }
            if (type == "0" || type == "1") {
                $("#btn_publish").hide();
                // $("#button").hide();
                $("#search").addClass('hide');
            }
            else {
                UserInfo(school_id, class_id, user_type);

                if (loadUnread == 1) {
                    GetList();
                }
            }

            //if (type != "1") {
            //    //UserInfo(809, 0, 0);
            //    //获取用户选中的身份
            //    if (!strIsNullOrEmpty(uid) && strIsNullOrEmpty(user_type) && strIsNullOrEmpty(class_id)) {

            //        if (type == "0") {
            //            document.addEventListener('WebViewJavascriptBridgeReady', function (event) {
            //                bridge = event.bridge;
            //            }, false);
            //            //var data = surfaceView.getUserInfo();
            //            var data = bridge.callHandler('getUserInfo');
            //            if (!strIsNullOrEmpty(data)) {
            //                data = $.parseJSON(data);
            //                UserInfo(data.school_id, data.class_id, data.user_type);
            //            }
            //            else {
            //                UserInfo(school_id, class_id, user_type);
            //            }
            //        }
            //        else if (strIsNullOrEmpty(type)) {
            //            UserInfo(school_id, class_id, user_type);
            //        }
            //    }
            //    else {
            //        UserInfo(school_id, class_id, user_type);
            //    }



            //    SetMenu();


            //    if (loadUnread == 1) {

            //        GetList();
            //    }
            //}


            $("#btn_search").click(function () {
                txt = $("#search").val();
                index = 1;
                size = 10;
                count = 0;
                firstLoad = true;
                $("#list").html("");
                GetList();
            });

            $("#btn_publish").click(function () {
                Publish();
            });

        });

        //.ckall 点击事件
        function ckallclick() {
            var isc = $(".chkall").prop('checked');
            //$(".delLot").attr("checked", isc);
            if (isc) {
                $(".delLot").each(function () {
                    $(this).prop('checked', true);
                    $(this).addClass('ckboxon');
                    $(this).removeClass('ckboxout');
                })
            } else {
                $(".delLot").each(function () {
                    $(this).prop('checked', false);
                    $(this).addClass('ckboxout');
                    $(this).removeClass('ckboxon');
                })
            }
            //ischeckSpecile($(".delLot"), false);
            if (isc) {
                $(".span_chkall").text("取消全选");
            }
            else {
                $(".span_chkall").text("全选");
            }
            var jalen;
            jalen = $('.delLot.ckboxon').length;
            UpdateMenu(jalen);
        }
        // .delLot 点击事件
        function delLotclick(a) {
            var isc = $(a).find("input").prop("checked");
            if (!isc) {
                //$(".chkall").attr("checked", false);
                $(".chkall").prop("checked", false);
                $('.chkall').addClass('ckboxout');
                $('.chkall').removeClass('ckboxon');
                $(".span_chkall").text("全选");
            }
            else {
                if ($(".delLot.ckboxon").length == $(".delLot").length) {
                    $('.chkall').addClass('ckboxon');
                    $('.chkall').prop('checked', true)
                    $('.chkall').removeClass('ckboxout');
                    $(".span_chkall").text("取消全选");
                }
                else {
                    // $(".chkall").attr("checked", false);
                    $('.chkall').prop('checked', false)
                    $('.chkall').addClass('ckboxout');
                    $('.chkall').removeClass('ckboxon');
                    $(".span_chkall").text("全选");
                }
            }
            //ischeckSpecile($(".chkall"), false);
            UpdateMenu($(".delLot.ckboxon").length);
        }

        //#region 设置身份
        var class_name = "";
        var roleCount = 0;
        function UserInfo(s_id, c_id, u_type) {
            $.ajax({
                type: "get",
                async: false,
                url: domain + 'api/HomeSchoolCommunication/GetChoiceIdentity',
                data: {
                    uid: uid,
                    select_type: 3
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                },
                success: function (json) {
                    var html = '';
                    roleCount = json.total;
                    if (json.total > 0) {
                        var text = '';
                        if (!strIsNullOrEmpty(u_type) && (!strIsNullOrEmpty(s_id) || !strIsNullOrEmpty(c_id))) {
                            text = setInfo(json, s_id, c_id, u_type);

                        } else {
                            text = setFirstDefault(json, u_type);
                        }
                        if (json.total > 1) {
                            //$('#divCurrIdentity').unbind('click');
                            $('.mclass').removeClass('hide');
                            $('.clearunread').parent().removeClass('patbb');
                        }
                        $('.loading').addClass('hide');
                        $('#div_identity_main').removeClass('hide');
                        $('#divCurrIdentity').text('校务通知' + (strIsNullOrEmpty(text) ? "" : (" " + text)));
                        if (GetUnreadCountOther(json)) {
                            $('.divCurrIdentity .mclass').css({ 'position': 'relative' }).append('<span class="redpoint"></span>');
                        }
                        class_name = text;
                        var paramArray =
                        {
                            title: title,
                            children: []
                        };
                        resetTitle(paramArray);
                    } else {
                        loadUnread = 0;
                        $('body').empty();
                        html = '<div class="nodata noclass">您还没有班级哦</div>';
                        html += '<div class="tcenter mtonerem"><div class="btn btnmbig btnyellow" onclick="createClass()">去创建班级</div></div>';
                        html += '<div class="tcenter mtb5" ><div class="btn btnmbig btnyellow" onclick="joinClass()">去加入班级</div></div>';
                        $('body').append(html);
                    }
                }
            });
        }

        function SetMenu() {
            $(".delLot").removeClass("ckboxon");
            $(".delLot").addClass("ckboxout");
            $(".chkall").removeClass("ckboxon");
            $(".chkall").addClass("ckboxout");
            can_scorll = true;
            addListener();
            //设置右键
            var children2 = [];
            children2.push({
                title: "搜索",
                url: 'Search()',
                urlType: 2,
                childTitle: ''
            });
            if (user_type == "0") {
                if (hasRole(uid, school_id, class_id, user_type, "2")) {
                    children2.push({
                        title: "发布",
                        url: 'Publish()',
                        urlType: 2,
                        childTitle: ''
                    });
                }
            }
            children2.push({
                title: "清空",
                url: 'delAll()',
                urlType: 2,
                childTitle: ''
            });
            children2.push({
                title: "批量删除",
                url: 'deleteItem()',
                urlType: 2,
                childTitle: ''
            });
            //if (roleCount > 1) {
            //    children2.push({
            //        title: "切换班级",
            //        url: 'changeIdentity()',
            //        urlType: 2,
            //        childTitle: ''
            //    });
            //}

            var paramArray = {
                title: null,
                children: children2
            }
            resetTitle(paramArray);
        }
        function UpdateMenu(selCount) {
            var paramArray =
            {
                title: "已选择" + selCount,
                children: [{
                    title: "删除",
                    url: 'delLot()',
                    urlType: 2,
                    childTitle: ''
                }]
            };
            resetTitle(paramArray);
        }
        function changeIdentity() {
            var array = {
                title: '校务通知',
                url: '/HomeSchoolCommunication/choiceclass.html?uid=' + uid + '&user_type=' + user_type + '&school_id=' + school_id + '&class_id=' + class_id + "&select_type=3" + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: []
            };
            appRedirect(array);
        }
        var title;
        function setInfo(json, s_id, c_id, u_type) {
            var text = "";
            var shouldset = true;
            $.each(json.rows, function (i, n) {
                if (u_type == 1 && u_type == n.user_type && c_id == n.class_id) {
                    shouldset = false;
                    // text = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                    user_type = n.user_type;
                    school_id = strIsNullOrEmpty(n.school_id) ? 0 : n.school_id;
                    class_id = strIsNullOrEmpty(n.class_id) ? '' : n.class_id;
                    class_creator = strIsNullOrEmpty(n.class_creator) ? '' : n.class_creator;
                    if (school_id == "0") {
                        title = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                    }
                    else {
                        text = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                        title = n.school_name;
                    }
                    return false;
                } else if ((u_type == "0" || u_type == 4) && u_type == n.user_type && !strIsNullOrEmpty(c_id) && c_id != 0 && c_id == n.class_id) {
                    shouldset = false;
                    // text = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                    user_type = n.user_type;
                    school_id = strIsNullOrEmpty(n.school_id) ? 0 : n.school_id;
                    class_id = strIsNullOrEmpty(n.class_id) ? '' : n.class_id;
                    class_creator = strIsNullOrEmpty(n.class_creator) ? '' : n.class_creator;
                    if (school_id == "0") {
                        title = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                    }
                    else {
                        text = !strIsNullOrEmpty(n.class_name) ? n.class_name : n.class_remark;
                        title = n.school_name;
                    }
                    return false;
                } else if ((u_type == "0" || u_type == 4) && u_type == n.user_type && !strIsNullOrEmpty(s_id) && s_id != 0 && s_id == n.school_id) {
                    shouldset = false;
                    title = n.school_name;
                    user_type = n.user_type;
                    school_id = strIsNullOrEmpty(n.school_id) ? 0 : n.school_id;
                    class_id = strIsNullOrEmpty(n.class_id) ? '' : n.class_id;
                    class_creator = strIsNullOrEmpty(n.class_creator) ? '' : n.class_creator;
                    return false;
                }
            });
            if (shouldset) {
                text = setFirstDefault(json, u_type);
            }
            return text;
        }

        function setFirstDefault(json, u_type) {
            var text = "";
            var row = json.rows[0];
            user_type = row.user_type;
            school_id = strIsNullOrEmpty(row.school_id) ? 0 : row.school_id;
            class_id = strIsNullOrEmpty(row.class_id) ? '' : row.class_id;
            class_creator = strIsNullOrEmpty(row.class_creator) ? '' : row.class_creator;
            //if (user_type == "0") {
            //    text = !strIsNullOrEmpty(row.class_id) && row.class_id != 0 ? (!strIsNullOrEmpty(row.class_name) ? row.class_name : row.class_remark) : row.school_name;
            //} else {
            //    text = !strIsNullOrEmpty(row.class_name) ? row.class_name : row.class_remark;
            //}
            if (school_id == "0") {
                title = !strIsNullOrEmpty(row.class_name) ? row.class_name : row.class_remark;
            }
            else {
                text = !strIsNullOrEmpty(row.class_name) ? row.class_name : row.class_remark;
                title = row.school_name;
            }
            return text;
        }
        //#endregion

        //其他身份是否还有未读数
        function GetUnreadCountOther(json) {
            var has = false;

            $.each(json.rows, function (i, n) {
                if (user_type == 1 && user_type == n.user_type && class_id == n.class_id) {
                    return true;
                } else if ((user_type == 0 || user_type == 4) && user_type == n.user_type && !strIsNullOrEmpty(class_id) && class_id != 0 && class_id == n.class_id) {
                    return true;
                } else if ((user_type == 0 || user_type == 4) && user_type == n.user_type && !strIsNullOrEmpty(school_id) && school_id != 0 && school_id == n.school_id) {
                    return true;
                } else {
                    if (n.unread_count > 0) {
                        has = true;
                        return true;
                    }
                }
            });
            return has;
        }

        $(window).scroll(function () {
            if (can_scorll) {
                var scrollTop = $(this).scrollTop();
                var scrollHeight = $(document).height();
                var windowHeight = $(this).height();
                if (scrollTop + windowHeight == scrollHeight) {
                    setTimeout(function () {
                        GetList();
                    }, 400);
                }
            }
        })

        function GetList() {
            if (strIsNullOrEmpty(school_id)) school_id = 0
            if (firstLoad || (index - 1) * size < count) {
                $.ajax({
                    type: "get",
                    async: true,
                    url: domain + "api/HomeSchoolCommunication/GetMessageList",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        class_id: class_id,
                        school_id: school_id,
                        mes_type_id: getMesTypeId("通知"),
                        txt: txt,
                        status: 0,
                        pageindex: index,
                        pagesize: size
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        if (data.rows.length > 0) {

                            var listStr = "";
                            listStr += "<div class='tright bgwhite'>";
                            for (var i = 0; i < data.rows.length; i++) {
                                var plan = new Date(convertDateTimeToString(parseISO8601(data.rows[i].get_date)));
                                var now = new Date();
                                if (user_type == "0" || user_type == "4") {

                                    if (data.rows[i].message_type_name == "get") {
                                        listStr += "<div class='wb relative litems ' mes_send_id=\"" + data.rows[i].mes_send_id + "\" id=\"" + data.rows[i].id + "\">";
                                    } else {
                                        listStr += "<div class='wb relative litems' mes_send_id=\"" + data.rows[i].mes_send_id + "\" id=\"" + data.rows[i].mes_send_id + "\">";
                                    }
                                }
                                else if (user_type == "1") {
                                    listStr += "<div class='wb relative  litems' mes_send_id=\"" + data.rows[i].id + "\" id=\"" + data.rows[i].id + "\">";
                                }

                                //if ((user_type == "0" && plan > now) || (data.rows[i].mes_status != "1" && user_type == "0") || ((user_type == "0" || user_type == "4") && data.rows[i].message_type_name == "get")) {
                                //if (user_type == "0" || user_type == "4") {
                                //删除
                                if (type == "0") {
                                    //if (data.rows[i].message_type_name == "get") {
                                    listStr += "<div class='andelete wb hide'><div class='patblr' onclick=\"Del('" + data.rows[i].id + "');event.stopPropagation();\">删除</div><div class='ancancel patblr' onclick='cancel(this)'>取消 </div></div>";
                                    //}
                                    //else {
                                    //    listStr += "<div class='andelete wb hide'><div class='patblr' onclick=\"Del(" + data.rows[i].mes_send_id + ",'" + data.rows[i].message_type_name + "');event.stopPropagation();\">删除</div><div class='ancancel patblr' onclick='cancel(this)'>取消 </div></div>";
                                    //}
                                }
                                //}
                                //else if (uid == data.rows[i].uid_get && user_type == "1") {
                                //    //删除
                                //    if (type == "0") {
                                //        listStr += "<div  class='andelete wb hide'><div class='patblr' onclick=\"Del(" + data.rows[i].id + ",'" + data.rows[i].message_type_name + "');event.stopPropagation();\">删除</div><div  class='ancancel patblr' onclick='cancel(this)'>取消 </div></div>";
                                //    }
                                //}
                                //if (!((user_type == "0" && plan > now) || (data.rows[i].mes_status != "1" && user_type == "0")) && !(uid == data.rows[i].uid_get && user_type == "1") && !((user_type == "0" || user_type == "4") && data.rows[i].message_type_name == "get")) {

                                //    listStr += "<div class=' widper100 wb   relative bb1 bgwhite'>";
                                //}
                                //else {
                                listStr += "<div class='nitem  widper100   wb relative bb1 bgwhite '>";
                                //}
                                listStr += "<div class=' tcenter mlper3'>";
                                //if (!strIsNullOrEmpty(data.rows[i].mes_pic)) {
                                //    listStr += "<img  class='widper100 mt10' src='" + adminURL + "upload_mes_img/" + school_id + "/thumbnail_" + data.rows[i].mes_pic + "' />"
                                //} else {
                                //    listStr += "<img   class='widper100 mt10' src='../../images/noticedefault.png' />"
                                //}
                                if (data.rows[i].message_type_name == 'send') {
                                    listStr += "<img class='noticeitem  mtonerem ' src='../../images/unread_hknotitle.png' />"
                                } else if (data.rows[i].message_type_name == 'get') {
                                    if (data.rows[i].status == "0") {
                                        listStr += "<img class='noticeitem  mtonerem ' src='../../images/unread_notice.png' />"
                                    }
                                    else {
                                        listStr += "<img class='noticeitem  mtonerem ' src='../../images/read_notice.png' />"
                                    }

                                }
                                listStr += "</div>";
                                if (data.rows.length - i == 1) {
                                    if (data.rows[i].status == "0") {
                                        listStr += "<div class='adritem mlper3 widper80 tleft  last  '>";
                                    } else {
                                        listStr += "<div class='adritem mlper3 widper80 tleft  last  '>";
                                    }

                                } else {
                                    if (data.rows[i].status == "0") {
                                        listStr += "<div class='adritem mlper3 widper80 tleft  last  '>";
                                    } else {
                                        listStr += "<div class='adritem mlper3 widper80 tleft  last '>";
                                    }
                                }
                                if (user_type == "0" || user_type == "4") {

                                    listStr += "<div class='cli' clickevent=\"GoDetail(" + data.rows[i].id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "',null,this," + data.rows[i].uid_send + ")\" >"; //

                                }
                                else {
                                    listStr += "<div class='cli'  clickevent=\"GoDetail(" + data.rows[i].id + "," + data.rows[i].mes + "," + data.rows[i].mes_status + ",'" + data.rows[i].message_type_name + "'," + data.rows[i].uid_child + ",this," + data.rows[i].uid_send + ")\" id=\"" + data.rows[i].id + "\">"; //
                                }
                                if (!strIsNullOrEmpty(data.rows[i].title)) {

                                    listStr += "<div class='widper100  nowrap wb'>"
                                    listStr += "<div class='widper60  nowrap'>"
                                    if (data.rows[i].message_type_name == 'get') {
                                        if (data.rows[i].status == "0") {
                                            listStr += "<span class='mes_title'>" + data.rows[i].title + "</span>";
                                        }
                                        else {
                                            listStr += "<span class='g-font mes_title'>" + data.rows[i].title + "</span>";
                                        }
                                    } else {
                                        listStr += "<span class='g-font mes_title'>" + data.rows[i].title + "</span>";
                                    }
                                    listStr += "</div>"
                                    var date = new Date();
                                    var today = date.getFullYear() + '-' + padLeft((parseInt(date.getMonth()) + 1), 2) + '-' + padLeft(date.getDate(), 2);
                                    if (convertDateToString(parseISO8601(data.rows[i].get_date)) == today) {
                                        listStr += "<div class='widper38 p14 g-font tright mes_get_date'>" + convertTimeToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                    }
                                    else if (convertYearToString(parseISO8601(data.rows[i].get_date)) == date.getFullYear().toString()) {
                                        listStr += "<div class='widper38 p14 g-font tright mes_get_date'>" + convertMothDayToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                    }
                                    else {
                                        listStr += "<div class='widper38 p14 g-font tright mes_get_date '>" + convertDateToString(parseISO8601(data.rows[i].get_date)) + "</div>";
                                    }

                                    listStr += "</div>"
                                }
                                if (!strIsNullOrEmpty(data.rows[i].context)) {
                                    listStr += "<div class='widper94 nowrap g-font p14 mes_context'>" + data.rows[i].context + "</div>";
                                }
                                listStr += "<div class='wb'>"
                                listStr += "<div class='widper75 p14 g-font tleft wb uid_send_name'>" + data.rows[i].uid_send_name;
                                if (data.rows[i].has_att) {
                                    listStr += "<div class='mlhalf'><img class='seeicon ml2' src='../../images/filelink.png'></img>" + data.rows[i].att_count + "个附件</div>"
                                }
                                listStr += "</div>"
                                //listStr += "<div class='widper60 p14 g-font tright' ><span>" + convertDateTimeToString(parseISO8601(data.rows[i].get_date)) + "</span></div>";

                                if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                    if (data.rows[i].mes_status == "0") {
                                        listStr += "<div class='y-font p14 mlper3 mes_status '>未审核</div>";
                                    }
                                    else if (data.rows[i].mes_status == "2") {
                                        listStr += "<div class='g-font p14 mlper3 mes_status'>未通过</div>";
                                    }
                                }


                                listStr += "</div>"
                                //if (!strIsNullOrEmpty(data.rows[i].mes_status)) {
                                //    if (data.rows[i].mes_status == "0") {
                                //        listStr += "<div class='y-font p14 mlper3 '>未审核</div>";
                                //    }
                                //    else if (data.rows[i].mes_status == "2") {
                                //        listStr += "<div class='g-font p14 mlper3'>未通过</div>";
                                //    }
                                //}
                                listStr += "</div>";
                                listStr += "</div>";
                                listStr += "</div>";

                                //if ((user_type == "0" && plan > now) || (data.rows[i].mes_status != "1" && user_type == "0") || ((user_type == "0" || user_type == "4") && data.rows[i].message_type_name == "get")) {

                                //删除
                                if (type == "1" || strIsNullOrEmpty(type)) {
                                    //if (data.rows[i].message_type_name == "get") {
                                    listStr += "<div class='cli' ><input type=\"button\" class='delete'  onclick=\"Del('" + data.rows[i].id + "');event.stopPropagation();\" value=\"删除\" /></div>";
                                    //    }
                                    //    else {
                                    //        listStr += "<div class='cli' ><input type=\"button\" class='delete'  onclick=\"Del(" + data.rows[i].mes_send_id + ",'" + data.rows[i].message_type_name + "');event.stopPropagation();\" value=\"删除\" /></div>";
                                    //    }
                                    //}
                                    //}
                                    //if (uid == data.rows[i].uid_get && user_type == "1") {
                                    //    //删除
                                    //    if (type == "1") {
                                    //        listStr += "<div  class='cli' ><a href=\"javascript:void(0);\" class='delete' onclick=\"Del(" + data.rows[i].id + ",'" + data.rows[i].message_type_name + "');event.stopPropagation();\">删除</a></div>";
                                    //    }
                                    //}
                                }


                                listStr += "</div>";
                            }
                            listStr += "</div>";

                            $("#list").append(listStr);
                            count = data.total;
                            index++;
                        }
                        else {
                            $("#list").html("<div class='nodata nonotice'>您还没有通知哦</div>");
                        }
                        $(".loading").remove();
                        firstLoad = false;
                        touchev();
                    }
                });
            }

        }

        function Search() {
            //$("#button").removeClass('hide');
            var array = {
                title: '发布通知',
                url: '/HomeSchoolCommunication/notice/noticesearch.html?uid=' + uid + "&uid_child=" + uid_child + "&school_id=" + school_id + "&user_type=" + user_type + "&class_id=" + class_id + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: []
            };
            appRedirect(array);
        }

        function Publish() {
            var array = {
                title: '发布通知',
                url: '/HomeSchoolCommunication/messageAdd.html?mes_type_id=2&uid=' + uid + "&uid_child=" + uid_child + "&school_id=" + school_id + "&user_type=" + user_type + "&class_id=" + class_id + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: [
                    {
                        title: '发布',
                        url: 'Filish()',
                        urlType: 2,
                        childTitle: ''
                    }]
            };
            appRedirect(array);
        }

        function GoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send) {

            //判断用户是否有查看详情的条件
            if (user_type == "1") {
                if (type == "1") {
                    bridge.callHandler("isHidden", {}, function (data) {
                        var isHidden = data.isHidden;
                        if (isHidden) {
                            Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj, 1);
                        }
                        else {
                            GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send);
                        }
                    });
                }
                else {
                    GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send);
                }
            }
            else {
                if (mes_status == "0") {
                    $(obj).find().addClass("g-font");
                    $(obj).parent().find(".noticeitem").attr("src", "../../images/read_notice.png");
                    var array = {
                        title: '通知详情',
                        url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&message_type_name=" + message_type_name + "&message_type_id=2" + "&version=" + request("version"),
                        urlType: 1,
                        close: false,
                        children: [
                        {
                            title: '修改',
                            url: 'Update()',
                            urlType: 2,
                            childTitle: ''
                        }]
                    };
                    appRedirect(array);
                } else {
                    if (uid == uid_send) {
                        var array = {
                            title: '通知详情',
                            url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&message_type_name=" + message_type_name + "&message_type_id=2" + "&version=" + request("version"),
                            urlType: 1,
                            close: false,
                            children: [
                            {
                                title: '查看统计',
                                url: 'ShowReport()',
                                urlType: 2,
                                childTitle: ''
                            }]
                        };
                        appRedirect(array);
                    }
                    else {
                        $(obj).find().addClass("g-font");
                        $(obj).parent().find(".noticeitem").attr("src", "../../images/read_notice.png");
                        var array = {
                            title: '通知详情',
                            url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child + "&class_id=" + class_id + "&message_type_name=" + message_type_name + "&message_type_id=2" + "&version=" + request("version"),
                            urlType: 1,
                            close: false,
                            children: []
                        };
                        appRedirect(array);
                    }
                }
            }

        }

        function GenGoDetail(id, is_now, mes_status, message_type_name, uid_child1, obj, uid_send) {
            $.ajax({
                type: "get",
                async: true,
                url: domain + "api/HomeSchoolCommunication/MessageShowForUser",
                data: {
                    uid: uid,
                    class_id: class_id,
                    is_now: is_now,
                    id: id,
                    message_type_id: 2
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                }, success: function (data) {
                    if (data.res == "0") {
                        var res_user_pay_type = data.res_user_pay_type;
                        if (res_user_pay_type == "2") {
                            var res_pay_score = data.res_pay_score;
                            var is_remind = 1;
                            if (type == "1" || type == "0") {
                                bridge.callHandler("getScoreReminder", { module: 5 }, function (data) {
                                    if (type == "0") {
                                        data = JSON.parse(data);
                                    }
                                    is_remind = data.is_remind;
                                    if (is_remind == 0) {
                                        Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                                    }
                                    else {
                                        Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                                    }
                                });
                            } else {
                                Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                            }
                            //else if (type == "0" && 'surfaceView' in window) {
                            //    is_remind = surfaceView.getScoreReminder(5);
                            //    if (is_remind == 0) {
                            //        Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                            //    }
                            //    else {
                            //        Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj);
                            //    }
                            //}

                        }
                        else {
                            Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                        }
                    }
                    else if (data.res == "2") {
                        choicetwo("积分不足，无法查阅！", "取消", function () { $('.overlay').hide(); }, "查看服务", function () {
                            var array = {
                                title: '班级服务',
                                url: '/customer/classservice.html?uid=' + uid + "&classid=" + class_id,
                                urlType: 1,
                                close: false,
                                children: []
                            };
                            appRedirect(array);
                        });
                    }
                    else if (data.res == "3") {
                        choicetwo("您没有购买班级包月服务，无法查阅！", "取消", function () { $('.overlay').hide(); }, "查看服务", function () {
                            var array = {
                                title: '班级服务',
                                url: '/customer/classservice.html?uid=' + uid + "&classid=" + class_id,
                                urlType: 1,
                                close: false,
                                children: []
                            };
                            appRedirect(array);
                        });
                    }
                    else if (data.res == "4") {
                        error("参数不足，不能查看");
                    }
                    else if (data.res == "5") {
                        error("该条" + getMesTypeName(2, 1) + "已被您删除，您无法查看详情");
                    }
                }
            });
        }

        function Del(id) {
            clear = true;
            choicetwo("<div class='acenter'>确认删除？</div>", "取消", function () { clear = false; touchev()}, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                //$.ajax({
                //    type: "get",
                //    async: false,
                //    url: domain + "api/HomeSchoolCommunication/MessageDelete",
                //    data: {
                //        id: id,
                //        someWhere: someWhere
                //    },
                //    error: function (XMLHttpRequest, textStatus, errorThrown) {
                //        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                //    }, success: function (data) {
                //        if (data.res > 0) {
                //            error("删除成功！");
                //            $("#" + id).remove();
                //        }
                //        else {
                //            error("删除失败！");
                //        }
                //        return false;
                //    }
                //});
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesDelLot",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        ids: id,
                        message_type_id: 2
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        clear = false;
                        $(".loading").remove();
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            location.reload();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });
        }
        $(function () {
            touchev();
        })

        function Remind(res_pay_score, id, is_now, mes_status, message_type_name, uid_child1, obj) {
            if (res_pay_score > 0) {

                dialogbox("<div>查看详情需要扣除您" + res_pay_score + "积分，确认查看？</div><label class='label relative mt10' onclick='ischeck(this,true)'><input class='ckboxout' type=\"checkbox\" id=\"remind\" /><span class='mlonerem g-font'>不再提示</span></label>", function () {

                    if (isChecked($("#remind"))) {
                        if (type == "1" || type == "0") {
                            bridge.callHandler("setScoreReminder", { module: 5, is_remind: 0 });
                        }
                        //else if (type == "0" && 'surfaceView' in window) {
                        //    surfaceView.setScoreReminder(JSON.stringify({ module: 5, is_remind: 0 }));
                        //}
                    }
                    Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
                });
            }
            else {
                Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj);
            }
        }

        function Unremind(id, is_now, mes_status, message_type_name, uid_child1, obj, nocut) {
            $(obj).addClass("g-font");
            $(obj).parent().find(".noticeitem").attr("src", "../../images/read_notice.png");
            var array = {
                title: '通知详情',
                url: '/HomeSchoolCommunication/messageDetail.html?id=' + id + "&is_now=" + is_now + "&user_type=" + user_type + "&uid=" + uid + "&uid_child=" + uid_child1 + "&class_id=" + class_id + "&message_type_name=" + message_type_name + (!strIsNullOrEmpty(nocut) ? "&nocut=" + nocut : "") + "&message_type_id=2" + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: []
            };
            appRedirect(array);
        }


        //加入班级
        function joinClass() {
            if (type == "1" && bridge) {
                bridge.send({ goEnterClass: true });
            } else if (type == "0" && bridge) {
                // surfaceView.goEnterClass();
                bridge.callHandler('goEnterClass', {});
            }
        }

        //创建班级
        function createClass() {
            if (type == "1" && bridge) {
                bridge.send({ goCreateClass: true });
            } else if (type == "0") {
                // surfaceView.goCreateClass();
                bridge.callHandler('goCreateClass', {});
            }
        }


        function changeIdentity() {
            var array = {
                title: '校务通知',
                url: '/HomeSchoolCommunication/choiceclass.html?uid=' + uid + '&user_type=' + user_type + '&school_id=' + school_id + '&class_id=' + class_id + "&select_type=3" + "&version=" + request("version"),
                urlType: 1,
                close: false,
                children: []
            };
            appRedirect(array);
        }
        function clearunred() {
            UnreadClear(uid, school_id, user_type, class_id, 3);
            var src_ = "../../images/read_notice.png";
            var i = 0;
            var bl = UnreadClear(uid, school_id, user_type, class_id, 3);
            if (bl) {
                $('.noticeitem').attr('src', src_);
                $('.cli').find('.widper60').addClass('g-font');
            }
        }
        //添加多选框，批量删除
        function deleteItem() {
            if (count == 0) {
                error("没有可删除的消息");
                return;
            }
            removeListener();
            can_scorll = false;
            UpdateMenu("0");
            var checkAll = '<div class="bgwhite bb1 del-all classitem">' +
                ' <label class="label relative wid100  mlhalf" onclick="ischeck(this, true),ckallclick();">' +
                     '  <input type="checkbox" class="ckbox chk_class ckboxout chkall">' +
                  ' <span class="labelspan mlonerem span_chkall">全选</span>' +
                  ' </label>' +
                '</div>';
            if ($('.del-all').length == 0) {
                $('#list').prepend(checkAll);
            } else {
                $('.del-all').show();
                $('.del-item').removeClass('del-hide').show();
            }
            if ($('.del-item').length !== 0) return;
            $('.litems').each(function () {
                var id = $(this).attr("mes_send_id");
                var checkObj = ' <label class="mt26 label relative wid100  mlhalf block del-item" onclick="ischeck(this, true),delLotclick(this);">' +
                        ' <input type="checkbox" class="ckbox chk_class ckboxout ckchild delLot " value="' + id + '">' +
                        '<span class="labelspan"></span>' +
                        ' </label>';
                $(this).find('.noticeitem ').parent().parent().prepend(checkObj);
                $(this).css('overflow', 'hidden');
            })

            //$(".chkall").click(function () {
            //    var isc = isChecked($(".chkall"));
            //    $(".delLot").attr("checked", isc);
            //    ischeckSpecile($(".delLot"), false);
            //    UpdateMenu($(".delLot:checked").length);
            //    if (isc) {
            //        $(".span_chkall").text("取消全选");
            //    }
            //    else {
            //        $(".span_chkall").text("全选");
            //    }
            //});
            //$(".delLot").click(function () {
            //    var isc = isChecked($(this));
            //    if (!isc) {
            //        $(".chkall").attr("checked", false);
            //        $(".span_chkall").text("全选");
            //    }
            //    else {
            //        if ($(".delLot:checked").length == $(".delLot").length) {
            //            $(".chkall").attr("checked", true);
            //            $(".span_chkall").text("取消全选");
            //        }
            //        else {
            //            $(".chkall").attr("checked", false);
            //            $(".span_chkall").text("全选");
            //        }
            //    }
            //    ischeckSpecile($(".chkall"), false);
            //    UpdateMenu($(".delLot:checked").length);
            //});
        }

        //取消批量删除
        function cancel() {
            $('.del-all').hide();
            $('.del-item').addClass('del-hide').one('webkitAnimationEnd', function () { $(this).hide() });
        }

        function ischeckSpecile(a, isParent) {
            var this_ = $(a);
            this_.each(function () {
                if (isParent) {
                    if (isChecked(this_.find('input[type="checkbox"]')) || this_.find('input[type="checkbox"]').attr("checked") == "checked") {
                        this_.find('input[type="checkbox"]').removeClass('ckboxout');
                        this_.find('input[type="checkbox"]').addClass('ckboxon');
                    } else {
                        this_.find('input[type="checkbox"]').removeClass('ckboxon');
                        this_.find('input[type="checkbox"]').addClass('ckboxout');
                    }
                }
                else {
                    if (isChecked($(this)) || $(this).attr("checked") == "checked") {
                        $(this).removeClass('ckboxout');
                        $(this).addClass('ckboxon');
                    } else {
                        $(this).removeClass('ckboxon');
                        $(this).addClass('ckboxout');
                    }
                }
            });
            //$("#chk_all").click();
        }
        function delLot() {
            var ids = "";
            $(".delLot").each(function () {
                //if (isChecked($(this))) {
                //    ids = ids + $(this).val() + ",";
                //}
                if ($(this).hasClass('ckboxon')) {
                    ids = ids + $(this).val() + ",";
                }
            });
            if (strIsNullOrEmpty(ids)) {
                error("请选择要删除的通知");
                return;
            }
            clear = true;
            choicetwo("确认删除已勾选的通知？", "取消", function () { clear = false; }, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesDelLot",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        ids: ids,
                        message_type_id: 2
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        clear = false;
                        $(".loading").remove();
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            SetMenu();
                            location.reload();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });

        }

        var clear = false;
        function delAll() {
            if (count == 0) {
                error("没有可清空的消息");
                return;
            }
            clear = true;
            choicetwo("确认清空校务通知？", "取消", function () { clear = false; }, "确定", function () {
                $("body").append('<div class="loading">加载中...</div>');
                $.ajax({
                    type: "get",
                    async: false,
                    url: domain + "api/HomeSchoolCommunication/MesClear",
                    data: {
                        uid: uid,
                        user_type: user_type,
                        school_id: school_id,
                        class_id: class_id,
                        mes_type_id: 2
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $(".loading").remove();
                        clear = false;
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {
                        clear = false;
                        $(".loading").remove();
                        if (data.res > 0) {
                            error("删除成功！");

                            //$(".delLot").each(function () {
                            //    if (isChecked($(this))) {
                            //        $(this).parent().parent().remove();
                            //    }
                            //});
                            location.reload();
                        }
                        else {
                            error("删除失败！");
                        }
                        return false;
                    }
                });
            });
        }

        function onClickBack() {
            if (clear) {  //在清空界面
                clear = false;
                $(".overlay").hide();
            }
            else {
                if (!can_scorll) {   //在批量删除界面，则返回到列表，否则返回上一页
                    dialogbox("确定退出批量删除？", function () {
                        //这里应该恢复滑动加载，恢复右键菜单和title
                        cancel();
                        SetMenu();
                    });
                }
                else {
                    var array = {
                        title: '',
                        url: '',
                        urlType: 1,
                        close: true,
                        children: []
                    };
                    appRedirect(array);
                }
            }
        }

        function UpdateInfo(id) {
            if (!strIsNullOrEmpty(id) && id > 0) {

                $.ajax({
                    type: "get",
                    async: true,
                    url: domain + "api/HSCForImageURL/GetSendInfo",
                    data: {
                        id: id,
                        is_now: null,
                        user_type: user_type,
                        uid: uid,
                        class_id: class_id,
                        uid_child: null,
                        message_type_name: ""
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        //error(XMLHttpRequest.responseText)
                        error("您当前的网络不稳定，请稍后重试。(" + XMLHttpRequest.status.toString() + ")");
                    }, success: function (data) {

                        if (data != null && data.rows != null && data.rows.length > 0) {
                            for (var i = 0; i < data.rows.length; i++) {
                                var obj = $("#" + id.toString());
                                $(obj).find(".mes_title").html(data.rows[i].title);

                                var str_date = '';
                                var date = new Date();
                                var today = date.getFullYear() + '-' + padLeft((parseInt(date.getMonth()) + 1), 2) + '-' + padLeft(date.getDate(), 2);
                                if (convertDateToString(parseISO8601(data.rows[i].get_date)) == today) {
                                    str_date = convertTimeToString(parseISO8601(data.rows[i].get_date));
                                }
                                else if (convertYearToString(parseISO8601(data.rows[i].get_date)) == date.getFullYear().toString()) {
                                    str_date = convertMothDayToString(parseISO8601(data.rows[i].get_date));
                                }
                                else {
                                    str_date = convertDateToString(parseISO8601(data.rows[i].get_date));
                                }
                                $(obj).find(".mes_get_date").html(str_date);
                                $(obj).find(".mes_status").html(data.rows[i].status == "0" ? "未审核" : data.rows[i].status == "1" ? "" : "未通过");
                                $(obj).find(".mes_context").html(data.rows[i].context);
                                $(obj).find(".uid_send_name").html(data.rows[i].publisher);
                            }
                        }

                    }
                });
            }
        }
    </script>
</head>
<body class="pabonerem">
    <div id="pageContext">
        <div class=" divCurrIdentity pa0">
            <div class="classhead noticehead">
                <div id="divCurrIdentity" class="p18 nowrap classtitle">
                    ...
                </div>
                <div class="patbb mlonerem">
                    <div onclick="changeIdentity();" class=" mclass hide btn-choosec changeclass p14 inline">切换班级</div>
                    <div onclick="dialogbox('确定将所有未读消息标记为已读？', clearunred)" class="  btn-choosec mt2 clearunread p14 inline">标记未读</div>
                </div>
            </div>
            <img src="../../images/kqbg.png" class="classimg" />
        </div>
        <input type="button" class="can_remove hide" id="btn_publish" value="发布" />
        <input type="button" class="can_remove hide" id="search" value="搜索" onclick="Search()" />
        <input type="button" class="can_remove hide" value="批量删除" onclick="deleteItem()" />
        <input type="button" class="can_remove hide" value="确定删除" onclick="delLot()" />
        <input type="button" class="can_remove hide" value="清空" onclick="delAll()" />
        <input type="button" class="can_remove hide" value="返回" onclick="onClickBack()" />
        <!--<div id="button" class="searchdiv wb hide">
            <div class="widper80">
                <input id="search" class="bgiconitem last indentb" placeholder="输入标题/内容进行查找" />
            </div>
            <div class="widper20 tright">
                <input type="button" id="btn_search" class="searbtn" />
            </div>
        </div>-->
        <div id="list" class="">
            <div class="loading">加载中...</div>
        </div>
    </div>
    <div id="class_list" class="mtonerem"></div>
</body>
</html>
